<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Beam search - OpenNMT</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  <link href="../../css/extra.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Beam search";
    var mkdocs_page_input_path = "translation/beam_search.md";
    var mkdocs_page_url = "/translation/beam_search/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script> 
  
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-89222039-1', 'opennmt.net');
      ga('send', 'pageview');
  </script>
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> OpenNMT</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Overview</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../installation/">Installation</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../quickstart/">Quickstart</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../applications/">Applications</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Data</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../data/preparation/">Preparation</a>
                </li>
                <li class="">
                    
    <a class="" href="../../data/word_features/">Word features</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Training</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../training/models/">Models</a>
                </li>
                <li class="">
                    
    <a class="" href="../../training/embeddings/">Embeddings</a>
                </li>
                <li class="">
                    
    <a class="" href="../../training/logs/">Logs</a>
                </li>
                <li class="">
                    
    <a class="" href="../../training/multi_gpu/">Multi GPU</a>
                </li>
                <li class="">
                    
    <a class="" href="../../training/retraining/">Retraining</a>
                </li>
                <li class="">
                    
    <a class="" href="../../training/regularization/">Regularization</a>
                </li>
                <li class="">
                    
    <a class="" href="../../training/decay/">Decay strategies</a>
                </li>
                <li class="">
                    
    <a class="" href="../../training/sampling/">Data sampling</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Translation</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../inference/">Inference</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Beam search</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#hypotheses-filtering">Hypotheses filtering</a></li>
    

    <li class="toctree-l3"><a href="#normalization">Normalization</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#length-normalization">Length normalization</a></li>
        
            <li><a class="toctree-l4" href="#coverage-normalization">Coverage normalization</a></li>
        
            <li><a class="toctree-l4" href="#end-of-sentence-normalization">End of sentence normalization</a></li>
        
        </ul>
    

    <li class="toctree-l3"><a href="#decoding-with-auxiliary-language-model">Decoding with auxiliary language model</a></li>
    

    <li class="toctree-l3"><a href="#output-attention-to-a-file">Output attention to a file</a></li>
    

    <li class="toctree-l3"><a href="#visualizing-the-beam-search">Visualizing the beam search</a></li>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../unknowns/">Unknown words</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Tools</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../tools/tokenization/">Tokenization</a>
                </li>
                <li class="">
                    
    <a class="" href="../../tools/scorer/">Scorer</a>
                </li>
                <li class="">
                    
    <a class="" href="../../tools/servers/">Servers</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Reference: Options</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../options/usage/">Scripts usage</a>
                </li>
                <li class="">
                    
    <a class="" href="../../options/preprocess/">preprocess.lua</a>
                </li>
                <li class="">
                    
    <a class="" href="../../options/train/">train.lua</a>
                </li>
                <li class="">
                    
    <a class="" href="../../options/translate/">translate.lua</a>
                </li>
                <li class="">
                    
    <a class="" href="../../options/tag/">tag.lua</a>
                </li>
                <li class="">
                    
    <a class="" href="../../options/lm/">lm.lua</a>
                </li>
                <li class="">
                    
    <a class="" href="../../options/build_vocab/">tools/build_vocab.lua</a>
                </li>
                <li class="">
                    
    <a class="" href="../../options/release_model/">tools/release_model.lua</a>
                </li>
                <li class="">
                    
    <a class="" href="../../options/tokenize/">tools/tokenize.lua</a>
                </li>
                <li class="">
                    
    <a class="" href="../../options/learn_bpe/">tools/learn_bpe.lua</a>
                </li>
                <li class="">
                    
    <a class="" href="../../options/server/">tools/translation_server.lua</a>
                </li>
                <li class="">
                    
    <a class="" href="../../options/rest_server/">tools/rest_translation_server.lua</a>
                </li>
                <li class="">
                    
    <a class="" href="../../options/embeddings/">tools/embeddings.lua</a>
                </li>
                <li class="">
                    
    <a class="" href="../../options/average_models/">tools/average_models.lua</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../lua_python_comparison/">Lua and Python OpenNMT</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../references/">References</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../issues/">Common issues</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">OpenNMT</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Translation &raquo;</li>
        
      
    
    <li>Beam search</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/OpenNMT/OpenNMT/edit/master/docs/translation/beam_search.md"> Edit on OpenNMT/OpenNMT</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p>By default, translation is done using beam search. The <code>-beam_size</code> option can be used to trade-off translation time and search accuracy, with <code>-beam_size 1</code> giving greedy search. The small default beam size is often enough in practice.</p>
<p>Beam search can also be used to provide an approximate n-best list of translations by setting <code>-n_best</code> greater than 1. For analysis, the translation command also takes an oracle/gold <code>-tgt</code> file and will output a comparison of scores.</p>
<h2 id="hypotheses-filtering">Hypotheses filtering<a class="headerlink" href="#hypotheses-filtering" title="Permanent link">&para;</a></h2>
<p>The beam search provides a built-in filter based on unknown words: <code>-max_num_unks</code>. Hypotheses with more unknown words than this value are dropped.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As dropped hypotheses temporarily reduce the beam size, the <code>-pre_filter_factor</code> is a way to increase the number of considered hypotheses before applying filters.</p>
</div>
<h2 id="normalization">Normalization<a class="headerlink" href="#normalization" title="Permanent link">&para;</a></h2>
<p>The beam search also supports various normalization techniques that are disabled by default and can be used to biased the scores generated by the model:</p>
<p>$$s(Y,X)=\frac{\log P(Y|X)}{lp(Y)}+cp(X,Y)$$</p>
<p>where (X) is the source, (Y) is the current target, and the functions as defined below. An additional penalty on end of sentence tokens can also be added to prioritize longer sentences.</p>
<h3 id="length-normalization">Length normalization<a class="headerlink" href="#length-normalization" title="Permanent link">&para;</a></h3>
<p>Scores are normalized by the following formula as defined in <a href="../../references/#GNMT">Wu et al. (2016)</a>:</p>
<p>$$lp(Y) = \frac{(5+|Y|)^\alpha}{(5+1)^\alpha}$$</p>
<p>where (|Y|) is the current target length and (\alpha) is the length normalization coefficient <code>-length_norm</code>.</p>
<h3 id="coverage-normalization">Coverage normalization<a class="headerlink" href="#coverage-normalization" title="Permanent link">&para;</a></h3>
<p>Scores are penalized by the following formula as defined in <a href="../../references/#GNMT">Wu et al. (2016)</a>:</p>
<p>$$cp(X,Y) = \beta\sum_{i=1}^{|X|}\log(\min(\sum_{j=1}^{|Y|}p_{i,j},1.0))$$</p>
<p>where (p_{i,j}) is the attention probability of the (j)-th target word (y_j) on the (i)-th source word (x_i), (|X|) is the source length, (|Y|) is the current target length and (\beta) is the coverage normalization coefficient <code>-coverage_norm</code>.</p>
<h3 id="end-of-sentence-normalization">End of sentence normalization<a class="headerlink" href="#end-of-sentence-normalization" title="Permanent link">&para;</a></h3>
<p>The score of the end of sentence token is penalized by the following formula:</p>
<p>$$ep(X,Y)=\gamma\frac{|X|}{|Y|}$$</p>
<p>where (|X|) is the source length, (|Y|) is the current target length and (\gamma) is the end of sentence normalization coefficient <code>-eos_norm</code>.</p>
<h2 id="decoding-with-auxiliary-language-model">Decoding with auxiliary language model<a class="headerlink" href="#decoding-with-auxiliary-language-model" title="Permanent link">&para;</a></h2>
<p>Beam search can use an additional language model to modify score of each option as defined in <a href="../../references/#LMShallowFusion">Gulcehre et al. (2015)</a> as "Shallow Fusion":</p>
<p>$$s(Y,X) = s_{TM}(Y,X) + \beta.s_{LM}(Y)$$</p>
<p>Where (s_{LM}(Y)) is the language model log-probability of the sequence  (Y) and (\beta) is defined by <code>-lm_weight</code> parameter.
To activate the language model, simply use <code>-lm_model lm.t7</code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The language model cannot use bidirectional RNN and needs to share the same vocabulary (tokens and features) than the translation model.</p>
</div>
<h2 id="output-attention-to-a-file">Output attention to a file<a class="headerlink" href="#output-attention-to-a-file" title="Permanent link">&para;</a></h2>
<p>The option <code>-save_attention FILE</code> can be used to save attention state to a file during translation. The format of the file is as following (compatible with NEMATUS):</p>
<div class="codehilite"><pre><span></span>sentence id ||| target words ||| score ||| source words ||| number of source words ||| number of target words
ALIGNMENT FOR T_1
ALIGNMENT FOR T_2
...
ALIGNMENT FOR T_n
</pre></div>


<p>Where <code>T_1</code> ... <code>T_n</code> are the target words - each alignement line is space separated probability to source word.</p>
<h2 id="visualizing-the-beam-search">Visualizing the beam search<a class="headerlink" href="#visualizing-the-beam-search" title="Permanent link">&para;</a></h2>
<p>To visualize the beam search exploration, you can use the option <code>-save_beam_to beam.json</code>. It will save a JSON serialization of the beam search history.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This option requires the <code>dkjson</code> package.</p>
</div>
<p>This representation can then be visualized dynamically using the <code>generate_beam_viz.py</code> script from the <a href="https://github.com/OpenNMT/VisTools"><code>OpenNMT/VisTools</code></a> repository:</p>
<div class="codehilite"><pre><span></span>git clone https://github.com/OpenNMT/VisTools.git
<span class="nb">cd</span> VisTools
mkdir out/
python generate_beam_viz.py -d ~/OpenNMT/beam.json -o out/
firefox out/000000.html
</pre></div>


<p><img alt="Beam search visualization" src="../../img/beam_search.png" /></p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../unknowns/" class="btn btn-neutral float-right" title="Unknown words">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../inference/" class="btn btn-neutral" title="Inference"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../inference/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../unknowns/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>

</body>
</html>
